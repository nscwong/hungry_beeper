<!doctype html>
<head>
  <meta charset="utf-8">

  <title>Hungry Beeper</title>
  <meta name="description" content="My Parse App">
  <meta name="viewport" content="width=device-width">
  <!--<link rel="stylesheet" href="css/reset.css">-->
  <!--<link rel="stylesheet" href="css/styles.css">-->
  <link rel="stylesheet" href="css/bootstrap.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
</head>

<body>
  
  <div id="main">
  <div class="jumbotron">
  <div class="container">
      <p>Welcome to the...</p>
      <h1>Hungry Beeper <small>Restaurant Management</small></h1>
  </div>
  </div>
  
  <div class="container">
    <FORM NAME="address">
    <INPUT TYPE="hidden" NAME="url">
    </FORM>

    <h2> Restaurant Information </h2>
    <p id="resTable"> </p> 

    <h3> Queue </h3>
    <p id="queueTable"> </p>
    Note: Queue Table is refreshed every 10 seconds. 

    <br><br>
    <h3> Requests </h3>
    <p id="requestTable"> </p>


    <br><br>
    <h2> Add Customer to Request Queue </h2>
    
    <form id="addRequestForm">
      <div class="form-group">
        <label for="customerId">Customer ID: </label>
        <input type="text" name="customerId" value="61C5I68fFi" placeholder="Example: 61C5I68fFi (Charley Chen)">
      </div>
      <div class="form-group">
        <label for="headCount">Head Count: </label>
        <input type="number" name="headCount" value="4" placeholder="Example: 4">
      </div>
    </form>
    <button class="btn btn-primary" onclick="addRequestButton()">Add Request</button>

    <!--
    <br><br>
    <h2> Add Customer to Wait Queue </h2>

    <form id="addQueueForm" method="link" action="<script>window.location</script>">
      CustomerId: <input type="text" name="customerId" size="14"> <br>
      Head Count: <input type="number" name="headCount" style="width: 2em"> <br>
      Wait Time: <input type="number" name="waitTime" value="15" style="width: 2em"> <br>
      
    </form>
    <button onclick="addToQueueButton()">Add Customer </button>
    -->

    <br><br><br>
    <h2> Restaurant Lookup </h2>
    <form id="loginForm" class="form-inline" method="link" action="restaurant.html">
      <div class="form-group">
        <label for="loginFormID">Restaurant ID</label>
        <input type="text" class="form-control" id="loginFormID" name="resId" placeholder="e.g. QCzivaFPvQ">
      </div>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    
    <br><br>

  </div>

  <script type="text/javascript">
  Parse.initialize("4eehWGP5Kyy5b3OeFevhoD0hzIbsgv6Uik7eoExA", "AmGopvrWEdcNIoak9BdZlrWpzWjf2lCJHYBA9i1N");

  var locate = window.location;
  document.address.url.value = locate;
  var url = document.address.url.value;

  function getLastVar(str)
  {
    var point = str.lastIndexOf("=");
    return (str.substring(point+1, str.length));
  }

  var restaurantId = getLastVar(url);

  displayRestaurant(restaurantId);

  var resQueue;
  findResQueue(restaurantId, function(newQueue){ resQueue = newQueue; 
    displayQueue(resQueue);
  });

  findRequest(restaurantId, function(request){
    displayRequest(request);
  });


  function displayRestaurant(resId) {
    console.log("Attempting to Display Restaurant");
    console.log("id:" + restaurantId);

    var query = new Parse.Query("Restaurant");
    restaurantId = resId;

    query.get(restaurantId, {
      success: function(object) {

      // object is an instance of Parse.Object.
        console.log("Found Restaurant");
        var name = object.escape("name");
        var address = object.escape("address");

        text = "";
        text += "<table class='table table-striped'><tr>";
        text += "<tr><td></td><td><b>" + name + "</b></td>";
        text += "<tr><td>ID</td><td>" + restaurantId +"</td></tr>";
        text += "<tr><td>Address</td><td>" + address +"</td></tr>";

        text += "</table>"

        document.getElementById("resTable").innerHTML = text;

      },

      error: function(object, error) {
      // error is an instance of Parse.Error.
      text = "Restaurant not found!";
        document.getElementById("resTable").innerHTML = text;
        console.log("failed");
      }
    });    
  };

  function findResQueue(resId, callback){
    var query = new Parse.Query("Queue");
    query.equalTo("restaurantId", resId);
    query.find({
      success: function(results) {
        //console.log("Successfully retrieved " + results.length + " queues.");
        // Do something with the returned Parse.Object values
        var queue = [];

        for (var i = 0; i < results.length; i++) {
          var object = results[i];
          var cur = {};
          cur['queueId'] = object.id;
          cur['restaurantId'] = object.get('restaurantId');
          cur['customerId'] = object.get('customerId');
          cur['customerName'] = object.get('customerName');
          cur['headCount'] = object.get('headCount');
          cur['tableReady'] = object.get('tableReady');
          cur['valid'] = object.get('valid');
          //cur['waitTime'] = object.get('waitTime');
          var waitTime;
          var curTime = new Date();
          var targetTime = object.get('targetTime');
          waitTime = new Date(targetTime - curTime);
          console.log("t " + targetTime);
          console.log("c " + curTime);

          if (waitTime < 0)
            waitTime = 0;
          else 
            waitTime = waitTime.getMinutes()+1;


          console.log(waitTime);
  
          cur['waitTime'] = waitTime;

          object.set("waitTime", waitTime);
          object.save();


          //console.log(cur);
          queue.push(cur);
        }

        callback(queue);
      },
      error: function(error) {
        console.log("Error: " + error.code + " " + error.message);

      }
    });
  };


  function displayQueue(queue){
    if (queue.length == 0)
    {
      document.getElementById("queueTable").innerHTML = '<i>"No Customers in Queue"</i>';
    }
    else {
      var text = "<table class='table table-striped'>";
      text += "<thead>";
      text += "<tr>";
      text += "<th>Position</th>";
      text += "<th>Customer Name</th>"; // check to name eventually
      text += "<th>Head Count</th>";
      text += "<th>Wait Time</th>";
      text += "<th>Table Ready?</th>";
      text += "<th>Checked In</th>";
      text += "<th>Table is</th>";
      text += "<th>Remove</th>";
      text += "</tr>";
      text += "</thead>";

      // need code to convert customer ID to name.
      //console.log("queueToDisplay");
      //console.log(queue);

      text += "<tbody>";
      for (var i = 0; i < queue.length; i++)
      {
        var cur = queue[i];
        var t = "";

        t += "<td>" + (i+1) + "</td>";
        t += "<td>" + cur['customerName'] + "</td>";
        t += "<td>" + cur['headCount'] + "</td>";
        t += "<td>" + cur['waitTime'] + "</td>";
        t += "<td>" + boolToString(cur['tableReady']) + "</td>";
        t += "<td>" + boolToString(!cur['valid']) + "</td>";

        t += '<td> <button onclick=setTableReady("' + cur['queueId'] + '",true) class="btn btn-success"> Ready </button>'
        + ' <button onclick=setTableReady("' + cur['queueId'] + '",false) class="btn btn-warning"> Not Ready </button></td>';

        t += '<td> <button onclick=deleteQueue("' + cur['queueId'] + '") class="btn btn-danger"> X </button>';

        text += "<tr>" + t + "</tr>";
      }
      text += "</tbody>";

      text += "</table>";
      //console.log(text);

      document.getElementById("queueTable").innerHTML = text;
    }
  };

  function boolToString(val)
  {
    if (val)          
      return "Yes";
    else
      return "No";
  }


  function getCustomerName(customerId, callback){
    var query = new Parse.Query("User");

    query.get(customerId, {
      success: function(object) {

      // object is an instance of Parse.Object.
        //console.log("Found Customer");
        var name = object.escape("name");
        //console.log(name);
        callback(name);
      },

      error: function(object, error) {
      // error is an instance of Parse.Error.
      console.log("Customer Not Found");

      }
    }); 
  }

  function addToQueue(restaurantId, customerId, headCount, waitTime){
      getCustomerName(customerId, function(name){
        console.log("Adding:" + name);
        var newQueue = new Parse.Object("Queue");
        newQueue.set("restaurantId", restaurantId);
        newQueue.set("customerId", customerId);
        newQueue.set("headCount", headCount);
        newQueue.set("waitTime", waitTime);
        newQueue.set("customerName", name);
        newQueue.set("tableReady", false);
        newQueue.save();
      });
    };

  function addToQueueButton()
  {
    var form = document.getElementById('addQueueForm');
    var customerId = form.elements['customerId'].value;
    var headCount = Number(form.elements['headCount'].value);
    var waitTime = Number(form.elements['waitTime'].value);

    addToQueue(restaurantId, customerId, headCount, waitTime);
  }

  //addToQueue("QCzivaFPvQ", "9ByRh6cchy", 4, 20);
  function refresh(){
    location.reload();
  }

  function findRequest(resId, callback){
    var query = new Parse.Query("QueueRequest");
    query.equalTo("restaurantId", resId);
    query.find({
      success: function(results) {
        //console.log("Successfully retrieved " + results.length + " queues.");
        // Do something with the returned Parse.Object values
        var request = [];

        for (var i = 0; i < results.length; i++) {
          var object = results[i];
          var cur = {};
          cur['id'] = object.id;
          cur['restaurantId'] = object.get('restaurantId');
          cur['customerId'] = object.get('customerId');
          cur['customerName'] = object.get('customerName');
          cur['headCount'] = object.get('headCount');
          //cur['waitTime'] = object.get('waitTime');
          //cur['tableReady'] = object.get('tableReady');
          //console.log(cur);
          request.push(cur);
        }
        callback(request);
      },
      error: function(error) {
        console.log("Error: " + error.code + " " + error.message);
      }
    });
  };

  function displayRequest(queue){
    if (queue.length == 0)
    {
      document.getElementById("requestTable").innerHTML = '<i>"No Requests Currently"</i>';
    }

    else 
    {
      var text = "<table class='table table-striped'>";
      text += "<thead>";
      text += "<tr>";
      text += "<th>Position</th>";
      text += "<th>Customer Name</th>"; // check to name eventually
      text += "<th>Head Count</th>";
      text += "<th>Wait Time</th>";
      text += "<th>Approve</th>";
      text += "</tr>";
      text += "</thead>";

      // need code to convert customer ID to name.
      //console.log("queueToDisplay");
      //console.log(queue);

      text += "<tbody>";
      for (var i = 0; i < queue.length; i++)
      {
        var cur = queue[i];
        var t = "";
        t += "<td>" + (i+1) + "</td>";
        t += "<td>" + cur['customerName'] + "</td>";
        t += "<td>" + cur['headCount'] + "</td>";
        t += "<td>";
        t += "<form id='requestForm'><input type='number' name='waitTime' value='15' style='width: 3em'></form>" 
        t += "</td>";
        
        t += '<td> <button onclick=moveToQueue("' + cur['id'] + '") class="btn btn-success"> Approve </button>';
        t += ' <button onclick=deleteRequest("' + cur['id'] + '") class="btn btn-danger"> Delete </button></td>';

        text += "<tr>" + t + "</tr>";
      }
      text += "</tbody>";

      text += "</table>";
      //console.log(text);

      document.getElementById("requestTable").innerHTML = text;
    }
  };



  setInterval(function(){
    findResQueue(restaurantId, function(queue){ 
      displayQueue(queue);
    });
    findRequest(restaurantId, function(request){
      displayRequest(request);
    })
    }, 5000);


  function setTableReady(queueId, val){
    var query = new Parse.Query("Queue");

    query.get(queueId, {
      success: function(queue) {
        queue.set("tableReady", val);
        queue.save();
      },

      error: function(object, error) {
      // error is an instance of Parse.Error.
      text = "Queue!";
        console.log("failed");
      }
    });    
  };

  function moveToQueue(requestId)
  {
    var form = document.getElementById('requestForm');
    var waitTime = Number(form.elements['waitTime'].value);

    var query = new Parse.Query("QueueRequest");
    query.get(requestId, {
      success: function(request) {
        var restaurantId = request.get('restaurantId');
        var customerId = request.get('customerId');
        var headCount = request.get('headCount');
        var name = request.get('customerName');

        var newQueue = new Parse.Object("Queue");
        newQueue.set("restaurantId", restaurantId);
        newQueue.set("customerId", customerId);
        newQueue.set("headCount", headCount);
        newQueue.set("waitTime", waitTime);
        newQueue.set("customerName", name);
        newQueue.set("tableReady", false);

        var curTime = new Date();
        console.log("Cur Time:" + curTime);

        var targetTime = new Date(curTime);
        targetTime.setMinutes( curTime.getMinutes() + waitTime);
        console.log("Target Time:" + targetTime);


        newQueue.set("targetTime", targetTime);
        newQueue.save();

        request.destroy();
      },

      error: function(object, error) {
      // error is an instance of Parse.Error.
      text = "Queue!";
        console.log("failed");
      }
    });
  }

  function deleteRequest(requestId)
  {
    var query = new Parse.Query("QueueRequest");
    query.get(requestId, {
      success: function(request) {
        var name = request.get('customerName');
        request.destroy();
        console.log("Request for " + name + " is deleted!");
      },

      error: function(object, error) {
      // error is an instance of Parse.Error.
        console.log("Deleting Request failed");
      }
    });
  }

  function addToRequest(restaurantId, customerId, headCount){

      getCustomerName(customerId, function(name){
        console.log("Adding: " + name +"'s Request!");
        var newQueue = new Parse.Object("QueueRequest");
        newQueue.set("restaurantId", restaurantId);
        newQueue.set("customerId", customerId);
        newQueue.set("headCount", headCount);
        newQueue.set("customerName", name);
        newQueue.set("valid", true);
        newQueue.save();
      });
    };

  function addRequestButton()
  {
    var form = document.getElementById('addRequestForm');
    var customerId = form.elements['customerId'].value;
    var headCount = Number(form.elements['headCount'].value);

    addToRequest(restaurantId, customerId, headCount);
  }


  function deleteQueue(queueId)
  {
    var query = new Parse.Query("Queue");
    query.get(queueId, {
      success: function(result) {
        var name = result.get('customerName');
        result.destroy();
        console.log("Queue for " + name + " is deleted!");
      },

      error: function(object, error) {
      // error is an instance of Parse.Error.
        console.log("Deleting Queue failed");
      }
    });
  }



  </script>

  </div></body>

</html>
